<ion-header>
  <ion-toolbar>
    <ion-title>Dashboard</ion-title>
    <ion-button slot="end" fill="clear" (click)="refreshMetrics()">
      <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
    </ion-button>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="dashboard-container" *ngIf="metrics">
    <!-- Storage Warning Alert (FR-009, T046) -->
    <ion-card *ngIf="storageWarning" color="warning" class="warning-card">
      <ion-card-content>
        <div class="warning-content">
          <ion-icon name="warning-outline" class="warning-icon"></ion-icon>
          <div>
            <strong>Storage Warning</strong>
            <p>Storage usage is at {{ metrics.storageUsed.percentage }}%. Consider deleting old files.</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Quick Actions (FR-010, T047) -->
    <div class="quick-actions">
      <ion-button expand="block" (click)="navigateToCreate('article')" color="primary">
        <ion-icon slot="start" name="document-text-outline"></ion-icon>
        Create Article
      </ion-button>
      <ion-button expand="block" (click)="navigateToCreate('part')" color="primary">
        <ion-icon slot="start" name="hardware-chip-outline"></ion-icon>
        Create Part
      </ion-button>
      <ion-button expand="block" (click)="navigateToCreate('topic')" color="primary">
        <ion-icon slot="start" name="pricetags-outline"></ion-icon>
        Create Topic
      </ion-button>
    </div>

    <!-- Metrics Grid (FR-007, T040, T043, T044) -->
    <div class="metrics-grid">
      <app-metric-card
        label="Total Articles"
        [value]="metrics.totalArticles"
        icon="document-text-outline"
      ></app-metric-card>

      <app-metric-card
        label="Topics"
        [value]="metrics.totalTopics"
        icon="pricetags-outline"
      ></app-metric-card>

      <app-metric-card
        label="Computer Parts"
        [value]="metrics.totalParts"
        icon="hardware-chip-outline"
      ></app-metric-card>

      <app-metric-card
        label="Recent Uploads"
        [value]="metrics.recentUploads"
        icon="cloud-upload-outline"
        detail="Last 7 days"
      ></app-metric-card>

      <app-metric-card
        label="Pending Drafts"
        [value]="metrics.pendingDrafts"
        icon="document-outline"
      ></app-metric-card>

      <app-metric-card
        label="Storage Used"
        [value]="metrics.storageUsed.percentage + '%'"
        icon="cloud-outline"
        [detail]="formatBytes(metrics.storageUsed.bytes)"
        [warning]="storageWarning"
      ></app-metric-card>
    </div>

    <!-- Activity Feed (FR-008, T043) -->
    <ion-card class="activity-card">
      <ion-card-header>
        <ion-card-title>Recent Activity (Last 24h)</ion-card-title>
        <ion-card-subtitle>Page {{ currentPage }} of {{ Math.ceil(totalActivities / pageSize) || 1 }}</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div class="table-container" *ngIf="activities.length > 0; else noActivity">
          <table class="activity-table">
            <thead>
              <tr>
                <th>Action</th>
                <th>Item</th>
                <th>Admin</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let activity of activities">
                <td>
                  <div class="action-cell">
                    <ion-icon [name]="getActionIcon(activity.action_type)" class="action-icon"></ion-icon>
                    {{ formatActionType(activity.action_type) }}
                  </div>
                </td>
                <td>
                  <div *ngIf="activity.item_title" class="item-cell">
                    <ion-badge color="light" class="item-type">{{ activity.item_type }}</ion-badge>
                    <span class="item-title">{{ activity.item_title }}</span>
                  </div>
                  <span *ngIf="!activity.item_title" class="text-muted">-</span>
                </td>
                <td>{{ activity.admin_email }}</td>
                <td class="date-cell">{{ formatTimestamp(activity.created_at) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="pagination-controls" *ngIf="totalActivities > pageSize">
          <ion-button fill="clear" size="small" (click)="prevPage()" [disabled]="currentPage === 1">
            <ion-icon slot="start" name="chevron-back-outline"></ion-icon>
            Prev
          </ion-button>
          <ion-button fill="clear" size="small" (click)="nextPage()" [disabled]="currentPage * pageSize >= totalActivities">
            Next
            <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
          </ion-button>
        </div>

        <ng-template #noActivity>
          <div class="empty-state">
            <ion-icon name="list-outline" class="empty-icon"></ion-icon>
            <p>No activity in the last 24 hours</p>
          </div>
        </ng-template>
        <ion-button expand="block" fill="clear" routerLink="/admin/activity" class="view-all-btn">
          View All Activity
          <ion-icon slot="end" name="arrow-forward-outline"></ion-icon>
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Loading dashboard...</p>
  </div>
</ion-content>
