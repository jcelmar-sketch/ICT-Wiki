<ion-header>
  <ion-toolbar>
    <ion-button slot="start" fill="clear" routerLink="/admin/parts">
      <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
    </ion-button>
    <ion-title>{{ isEditMode ? 'Edit Part' : 'Create Part' }}</ion-title>
    <ion-button slot="end" fill="clear" (click)="onSave()" [disabled]="saving || loading">
      <ion-icon slot="start" name="save-outline"></ion-icon>
      {{ saving ? 'Saving...' : 'Save' }}
    </ion-button>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="form-container" *ngIf="!loading; else loadingState">
    <form [formGroup]="partForm">
      <!-- Basic Information -->
      <div class="section">
        <h2>Basic Information</h2>

        <!-- Name -->
        <ion-item
          [class.ion-invalid]="
            hasError('name', 'required') ||
            hasError('name', 'minlength') ||
            hasError('name', 'maxlength')
          "
        >
          <ion-label position="stacked">Part Name *</ion-label>
          <ion-input
            formControlName="name"
            placeholder="e.g., Intel Core i7-13700K"
          ></ion-input>
          <div
            class="error-message"
            *ngIf="partForm.get('name')?.touched && partForm.get('name')?.invalid"
          >
            {{ getErrorMessage('name') }}
          </div>
        </ion-item>

        <!-- Slug -->
        <ion-item
          [class.ion-invalid]="
            hasError('slug', 'required') ||
            hasError('slug', 'pattern') ||
            hasError('slug', 'notUnique')
          "
        >
          <ion-label position="stacked">Slug (URL) *</ion-label>
          <ion-input
            formControlName="slug"
            placeholder="auto-generated-from-name"
          ></ion-input>
          <div
            class="error-message"
            *ngIf="partForm.get('slug')?.touched && partForm.get('slug')?.invalid"
          >
            {{ getErrorMessage('slug') }}
          </div>
        </ion-item>

        <!-- Part Type -->
        <ion-item [class.ion-invalid]="hasError('part_type', 'required')">
          <ion-label position="stacked">Part Type *</ion-label>
          <ion-select formControlName="part_type" placeholder="Select type">
            <ion-select-option *ngFor="let type of partTypes" [value]="type">
              {{ type }}
            </ion-select-option>
          </ion-select>
          <div
            class="error-message"
            *ngIf="partForm.get('part_type')?.touched && partForm.get('part_type')?.invalid"
          >
            {{ getErrorMessage('part_type') }}
          </div>
        </ion-item>

        <!-- Brand -->
        <ion-item
          [class.ion-invalid]="
            hasError('brand', 'required') || hasError('brand', 'maxlength')
          "
        >
          <ion-label position="stacked">Brand *</ion-label>
          <ion-input formControlName="brand" placeholder="e.g., Intel, AMD, NVIDIA"></ion-input>
          <div
            class="error-message"
            *ngIf="partForm.get('brand')?.touched && partForm.get('brand')?.invalid"
          >
            {{ getErrorMessage('brand') }}
          </div>
        </ion-item>

        <!-- Description -->
        <ion-item [class.ion-invalid]="hasError('description', 'maxlength')">
          <ion-label position="stacked">Description</ion-label>
          <ion-textarea
            formControlName="description"
            placeholder="Brief description of the part (max 1000 chars)"
            [rows]="4"
          ></ion-textarea>
          <div
            class="error-message"
            *ngIf="partForm.get('description')?.touched && partForm.get('description')?.invalid"
          >
            {{ getErrorMessage('description') }}
          </div>
        </ion-item>

        <!-- Price -->
        <ion-item [class.ion-invalid]="hasError('price', 'min')">
          <ion-label position="stacked">Price (Optional)</ion-label>
          <ion-input
            formControlName="price"
            type="number"
            min="0"
            step="0.01"
            placeholder="0.00"
          ></ion-input>
          <div
            class="error-message"
            *ngIf="partForm.get('price')?.touched && partForm.get('price')?.invalid"
          >
            {{ getErrorMessage('price') }}
          </div>
        </ion-item>
      </div>

      <!-- Specifications -->
      <div class="section">
        <app-specs-editor
          [specs]="partForm.value.specs"
          (specsChange)="onSpecsChange($event)"
        ></app-specs-editor>
      </div>

      <!-- Images -->
      <div class="section">
        <app-multi-image-upload
          bucket="parts"
          [imageUrls]="partForm.value.images"
          (imageUrlsChange)="onImagesChange($event)"
        ></app-multi-image-upload>
      </div>

      <!-- Activity History -->
      <ion-card *ngIf="isEditMode" class="activity-history">
        <ion-card-header>
          <ion-card-title>Activity History</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="history-loading" *ngIf="historyLoading">
            <ion-spinner></ion-spinner>
          </div>
          <ion-list *ngIf="!historyLoading && activityHistory.length">
            <ion-item *ngFor="let log of activityHistory">
              <ion-badge slot="start" [color]="actionBadgeColor(log.action_type)">
                {{ formatAction(log.action_type) }}
              </ion-badge>
              <ion-label>
                <div class="history-title">{{ log.item_title || 'Part' }}</div>
                <div class="history-meta">{{ log.admin_email }} â€¢ {{ formatTimestamp(log.created_at) }}</div>
              </ion-label>
            </ion-item>
          </ion-list>
          <p class="text-muted" *ngIf="!historyLoading && !activityHistory.length">No activity recorded yet.</p>
        </ion-card-content>
      </ion-card>

      <!-- Actions -->
      <div class="form-actions">
        <ion-button expand="block" (click)="onSave()" [disabled]="saving || partForm.invalid">
          <ion-icon slot="start" name="save-outline"></ion-icon>
          {{ saving ? 'Saving...' : isEditMode ? 'Update Part' : 'Create Part' }}
        </ion-button>

        <ion-button
          *ngIf="isEditMode"
          expand="block"
          color="danger"
          fill="outline"
          (click)="onDelete()"
        >
          <ion-icon slot="start" name="trash-outline"></ion-icon>
          Delete Part
        </ion-button>
      </div>
    </form>
  </div>

  <ng-template #loadingState>
    <div class="loading-container">
      <ion-spinner></ion-spinner>
      <p>Loading part...</p>
    </div>
  </ng-template>
</ion-content>
